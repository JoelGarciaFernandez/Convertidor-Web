<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extractor de Audio ‚òÅÔ∏è</title>
    
    <link rel="stylesheet" href="style.css">
    
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <style>
        /* Estilos extra para la barra de progreso */
        .progress-container {
            width: 100%;
            background-color: #e0f7fa;
            border-radius: 15px;
            margin: 20px 0;
            height: 25px;
            overflow: hidden;
            display: none; /* Oculto por defecto */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>‚òÅÔ∏è Extractor R√°pido</h1>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab(event, 'mp4-mp3')">Video a Audio</div>
        <div class="tab" onclick="switchTab(event, 'yt')">YouTube</div>
    </div>

    <div id="mp4-mp3" class="section active">
        <p>Sube tu video para obtener el MP3.</p>

        <input type="file" id="uploader-mp4" accept="video/mp4" onchange="updateFileName()">
        
        <label for="uploader-mp4" class="upload-box" id="drop-zone">
            <span class="upload-icon">‚òÅÔ∏è</span>
            <span class="upload-text" id="upload-text">Haz clic para elegir un video</span>
            <div class="file-name-display" id="file-name-display"></div>
        </label>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>

        <button class="btn" id="btn-mp4-mp3" onclick="convertMp4ToMp3()" disabled>
            Espera, elige un archivo primero...
        </button>
        
        <p id="turbo-warning" style="color: orange; font-size: 12px; display: none; margin-top: 10px;">
            ‚ö†Ô∏è Modo lento activado: Aseg√∫rate de que "coi-serviceworker.js" est√° en la carpeta.
        </p>
    </div>

    <div id="yt" class="section">
        <p>Para YouTube, usa esta herramienta segura:</p>
        <a href="https://y2mate.com" target="_blank" style="text-decoration: none;">
            <button class="btn btn-yt">üöÄ Ir a Descargador YT</button>
        </a>
    </div>

    <div id="logs" style="display:none;"></div> <div id="output-link"></div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    let ffmpeg = null;
    let isEngineReady = false;

    // INICIALIZACI√ìN AUTOM√ÅTICA
    (async function initFFmpeg() {
        // Verificar si tenemos soporte multihilo (SharedArrayBuffer)
        if (typeof SharedArrayBuffer === 'undefined') {
            document.getElementById('turbo-warning').style.display = 'block';
            console.warn("SharedArrayBuffer no disponible. La conversi√≥n ser√° lenta.");
        }

        try {
            ffmpeg = createFFmpeg({ 
                log: false, // Quitamos logs para mejorar rendimiento ligeramente
                corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
            });
            
            await ffmpeg.load();
            isEngineReady = true;
            
            // Activar bot√≥n si ya hay archivo
            const fileInput = document.getElementById('uploader-mp4');
            if (fileInput.files[0]) {
                document.getElementById('btn-mp4-mp3').disabled = false;
                document.getElementById('upload-text').innerText = "‚úÖ Motor listo.";
            }
        } catch (e) {
            console.error(e);
            alert("Error cargando FFmpeg. Recarga la p√°gina.");
        }
    })();

    function updateFileName() {
        const input = document.getElementById('uploader-mp4');
        const fileNameDisplay = document.getElementById('file-name-display');
        const dropZone = document.getElementById('drop-zone');
        const btn = document.getElementById('btn-mp4-mp3');

        if (input.files && input.files[0]) {
            fileNameDisplay.innerText = "Archivo: " + input.files[0].name;
            dropZone.classList.add('file-selected');
            
            if (isEngineReady) {
                btn.disabled = false;
                btn.innerText = "üéµ Convertir a MP3";
            } else {
                btn.innerText = "Cargando motor...";
            }
        }
    }

    async function convertMp4ToMp3() {
        if (!isEngineReady) return alert("Espera a que cargue el sistema.");

        const fileInput = document.getElementById('uploader-mp4');
        const btn = document.getElementById('btn-mp4-mp3');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');

        if (!fileInput.files[0]) return;

        // UI Updates
        btn.disabled = true;
        btn.innerText = "‚è≥ Procesando...";
        progressContainer.style.display = 'block';
        document.getElementById('output-link').innerHTML = ''; // Limpiar descargas anteriores

        const file = fileInput.files[0];
        const fileName = 'input.mp4';

        // 1. Escribir archivo
        ffmpeg.FS('writeFile', fileName, await fetchFile(file));

        // 2. Configurar barra de progreso
        ffmpeg.setProgress(({ ratio }) => {
            const percent = (ratio * 100).toFixed(0);
            if(percent >= 0 && percent <= 100){
                progressBar.style.width = percent + "%";
                progressBar.innerText = percent + "%";
            }
        });

        // 3. COMANDO OPTIMIZADO PARA VELOCIDAD
        // -b:a 128k: Bitrate constante (m√°s r√°pido que variable)
        // -ar 44100: Frecuencia est√°ndar
        // -ac 2: Est√©reo
        // -preset ultrafast: Intenta priorizar velocidad
        await ffmpeg.run(
            '-i', fileName, 
            '-vn', 
            '-acodec', 'libmp3lame', 
            '-b:a', '128k', 
            '-ar', '44100', 
            'output.mp3'
        );

        // 4. Finalizaci√≥n
        progressBar.style.width = "100%";
        progressBar.innerText = "¬°Listo!";
        
        const data = ffmpeg.FS('readFile', 'output.mp3');
        createDownloadLink(data, 'audio_extraido.mp3', 'audio/mpeg');
        
        btn.innerText = "‚úÖ Conversi√≥n Terminada";
        // btn.disabled = false; // Opcional: dejar bloqueado para obligar a recargar
    }

    function createDownloadLink(data, filename, type) {
        const blob = new Blob([data.buffer], { type: type });
        const url = URL.createObjectURL(blob);
        const div = document.getElementById('output-link');
        
        div.innerHTML = `
            <a href="${url}" download="${filename}" style="text-decoration:none; display:block; margin-top:20px;">
                <button class="btn" style="background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%); color: #1a5c38;">
                    ‚¨áÔ∏è Descargar MP3
                </button>
            </a>`;
    }

    function switchTab(evt, tabId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        evt.currentTarget.classList.add('active');
    }
</script>

</body>
</html>